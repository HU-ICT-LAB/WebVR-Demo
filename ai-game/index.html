<html>
<head>
    <title> {test} AFrameBasics Project</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.0.0/dist/aframe-environment-component.min.js"></script>
    <script src="https://unpkg.com/aframe-event-set-component@4.0.1/dist/aframe-event-set-component.js"></script>
    <script src="https://unpkg.com/aframe-aabb-collider-component@3.1.0/dist/aframe-aabb-collider-component.min.js"></script>
    <script src="../scripts/browserMqtt.js" type="text/javascript"></script>
    <script src="../scripts/mqtt_client.js" type="text/javascript"></script>

    <script src="http://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>

<!--    60 second timer -->
    <script>
        function updatescore() {
            var score = document.querySelector("#score");
            var currentscore = score.getAttribute('text').value;
            client.publish('request_updatescore', currentscore)

        }

        AFRAME.registerComponent('timerdown', {
            init: function () {
                var sixtytimer = document.querySelector("#timer");
                let sixtyseconds = 5;
                setInterval(function () {
                    if (sixtyseconds == 0){
                        updatescore()
                        sixtytimer.setAttribute('text', 'value', "Score added!")
                        sixtyseconds = 5;

                    }
                    else {
                        sixtytimer.setAttribute('text', 'value', (sixtyseconds--));
                    }
                }, 1000);
            }
            })

    </script>
<!--    Hit registration and delay-->
    <script>
        let scoreagaindelay = 0;
        setInterval(function() {if (scoreagaindelay == 0) clearInterval(this)}, 1000);


        AFRAME.registerComponent('hit', {

            init: function () {

                this.el.addEventListener('hitstart', function(){
                    var scorenumber = document.querySelector("#score");

                    console.log("Item touched");
                    this.setAttribute('color', "#FF0000");
                    var currentscore = scorenumber.getAttribute('text').value;
                    console.log(currentscore);
                    if (scoreagaindelay === 0) {
                        scorenumber.setAttribute('text', 'value', +currentscore + 1);

                        //code that the robot moves away after the punch
                        var robot = document.querySelector("#robotmodel");
                        var currentposition= robot.getAttribute('position')
                        currentposition.z = currentposition.z + 0.1
                        robot.setAttribute('position', currentposition)
                        console.log("Dodged!")
                        scoreagaindelay = 1;
                    }
                })

                this.el.addEventListener('hitend', function(){
                    console.log("Item exited");
                    this.setAttribute('color', "#333333");
                })

            }
        });
    </script>

<!--    Hitbox registration and merging-->
    <script>
        AFRAME.registerComponent("hitbox", {
            init: function() {
                let body = document.createElement("a-box");
                let head = document.createElement("a-box");

                body.setAttribute("position", "0 110 0");
                body.setAttribute("mixin", "body");
                head.setAttribute("position", "0 70 0");
                head.setAttribute("mixin", "head");
                body.appendChild(head)

                this.el.appendChild(body);

            }
        })

        AFRAME.registerPrimitive("a-hitbox", {
            defaultComponents: {
                hitbox: {}
            }
        })

    </script>

<!--    Highscore updating-->
    <script>
        AFRAME.registerComponent('sethighscore', {
            init: function() {
                this.con = false


            },

            tick: function(){
                if(connected && !this.con) {
                    client.subscribe('hbo_ict_vr_game_score')
                    client.publish('request_scoretopic', "{0}")
                    mqtt_add_topic_callback('hbo_ict_vr_game_score', function (topic, message) {
                        var obj = JSON.parse(message);
                        console.log(obj)
                        this.newhighscore = "Top 10 leaderboard\n------------\n"
                        for (let x in obj) {
                            this.newhighscore = this.newhighscore + x + ": " + obj[x] + "\n"

                        }
                        console.log(this.newhighscore)
                        Highscoretext.setAttribute('text', 'value', this.newhighscore)
                    })
                    this.con = true
                }
            }
        });
    </script>

    <script>
        //    When not testing, this needs need to be run after hit detected
        AFRAME.registerComponent('modeldodgemovement', {
            init: function () {
                var predictedmove = document.querySelector("#testbox");
                var middlepoint = document.querySelector("#middlepoint");
                var robot = document.querySelector("#robotmodel");
                currentpos = robot.getAttribute('position');
                P = predictedmove.getAttribute('position');
                M = middlepoint.getAttribute('position');
                x_distance = M.x - P.x;
                console.log("distance: " + x_distance)
                var movemultiplier = 1/x_distance*0.2
                var robotmove = movemultiplier
                console.log(robotmove)
                console.log(currentpos)

                var animationMoveString = "property: position; from: "+ currentpos.x + " " + currentpos.y + " " + (currentpos.z-1) + "; to: " + robotmove + " " + currentpos.y + " " + (currentpos.z-1) + " dur: 10000; easing: linear"
                console.log(animationMoveString)
                robot.setAttribute("animation", animationMoveString)
                // robot.setAttribute('position', {x:robotmove, y:currentpos.y, z:currentpos.z-1})
                // console.log(robot.getAttribute('position'))


            }
            }

        )


    </script>
</head>
<body>
<a-scene>
    <!-- Assets -->
    <a-assets>
        <img id="floor" src="assets/textures/Carpet.jpg">
        <img id="Sky" src="assets/textures/background.jpg">
        <img id="Metal" src="assets/textures/Metal.png">
        <a-asset-item id="Robot" src="assets\models\Robot_gltf/scene.gltf"></a-asset-item>
        <a-mixin id="head" geometry="primitive:box; height:50; width:40; depth:30;" material="opacity: 0.3; transparent: true" ></a-mixin>
        <a-mixin id="body" geometry="primitive:box; height:70; width:60; depth:55;" material="opacity: 0.3; transparent: true" handle-events aabb-collider></a-mixin>

    </a-assets>
<!--     ScoreBoard-->
                <a-box color="#FFFFFF" src=#Metal width="3" height="1.5" depth="0.1" position="0 4 -6">
                    <a-circle color="#333333" side="double" position="1.3 0 0.08" radius="0.2"> </a-circle>
                    <a-circle color="#333333" side="double" position="-1.3 0 0.08" radius="0.2"> </a-circle>
                    <a-box color="#FFFFFF" src=#Metal width="10" height="0.5" depth="0.1" position="0 1 0" repeat="10 1"></a-box>
                    <a-box color="#333333" src=#Metal width="8" height="0.5" depth="0.5" rotation="0 0 90" position="5.25 -2.25 0"></a-box>
                    <a-box color="#333333" src=#Metal width="8" height="0.5" depth="0.5" rotation="0 0 90" position="-5.25 -2.25 0"></a-box>
                    <a-text id="score" value= "0" position="-1.1 0 0.08" scale="7 7 7"> </a-text>
                    <a-text id="timer" value= "60" position="-0.3 1 0.08" scale="2 2 2" timerdown> </a-text>
                    <a-box id="Highscoreboard" color="#A9A9A9" src=#Metal width="3" height="3" depth="0.1" position="-4 -0.75 0"  repeat="10 1">
                        <a-entity id="Highscoretext" text="value: Top 10 Leaderboard\n------------\ndaan:--\nruben:--\nfloris:--\nshaun:--\ncharlie:--\npieter:--\nmanneke:--\nwit:--\nman:--\nvrouw:--; color: #FFFFFF" position="1.70 0 0.11" scale="5 5 5" sethighscore></a-entity>
                    </a-box>
                </a-box>
    <!-- Sky -->
    <a-sky src="#Sky"
           radius="10"
           side="double">
    </a-sky>

    <!-- Arena -->
    <a-cylinder radius="2.75" height="4" color="#FFC65D" segments-radial="6" open-ended="True" side="double" position="0 -1 0" rotation="0 0 0" animation="property: position; from:0 -3 0; to: 0 0 0; repeat:indefinite; direction:alternate; dur: 7000; easing:linear"></a-cylinder>


    <!-- Floor -->
    <a-plane material="color: #FFFFFF; src: #floor; repeat: 5 5;"
             rotation="-90 0 0"
             scale="20 20 1"
             position="0 -0.1 0">
    </a-plane>




    <!--             Robot Playermodel & Hitbox -->
    <a-entity id="robotmodel" gltf-model="#Robot" scale="0.007 0.01 0.01" position="0 0 -1"
              animation="property: position; from: 0 0 -1; to: 0 0 0; dur: 10000; easing: linear">
        <a-hitbox color="#333333" position="0 2 0" >
            <a-circle
                    id="middlepoint" color="#000000" scale="5 3.5 50" position="0 140 0">
            </a-circle>
        </a-hitbox>
    </a-entity>

    <!--             Only Visible Hitbox connected Playermodel-->
<!--    <a-hitbox id="robotmodel" color="#333333" scale="0.007 0.01 0.01" position="0 0 -1">-->
<!--        <a-circle-->
<!--            id="middlepoint" color="#000000" scale="5 3.5 50" position="0 140 0">-->
<!--        </a-circle>-->
<!--    </a-hitbox>-->

    <!--             Test predicted movement box-->
    <a-box
        id="testbox" color="#808080" height="0.1" width="0.1" depth="0.1" position="-0.30 1.4 -1" modeldodgemovement>
    </a-box>


<!--    Camera and Oculus rift-->
    <a-entity wasd-controls id="rig" position="0 0 2">
        <a-entity id="camera" camera look-controls ></a-entity>
        <a-entity id="lefthand" aabb-collider="objects: a-box" oculus-touch-controls="hand: left" thumbstick-logging hit></a-entity>
        <a-entity id="righthand" aabb-collider="objects: a-box" oculus-touch-controls="hand: right" thumbstick-logging hit></a-entity>
    </a-entity>

</a-scene>
</body>

</html>
